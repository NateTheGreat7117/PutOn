<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>explore</title>
  <link rel="stylesheet" href="/assets/css/explore-page.css">
  <link rel="stylesheet" href="/assets/css/homepage-style.css">
  <link rel="stylesheet" href="/assets/css/drop-down-menu.css">
  <style>
    /* Filter sidebar toggle functionality */
    .filter-side-bar {
      transition: transform 0.3s ease;
    }

    .filter-side-bar.collapsed {
      transform: translateX(-100%);
    }

    .filter-toggle-btn {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #333;
      color: white;
      border: none;
      padding: 12px 8px;
      cursor: pointer;
      z-index: 1001;
      border-radius: 0 8px 8px 0;
      transition: left 0.3s ease;
      font-size: 18px;
      line-height: 1;
    }

    .filter-toggle-btn:hover {
      background: #555;
    }

    .filter-side-bar:not(.collapsed) ~ .filter-toggle-btn {
      left: 250px; /* Adjust based on your sidebar width */
    }

    /* Background color - change to any color you want */
    body {
      background-color: #F4F4F4;
    }

    .image-half {
      position: relative;
      overflow: hidden;
    }
    .image-reel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.2s ease-out;
    }
    .image-reel .reel-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease-out;
    }
    .image-reel .reel-image.active {
      opacity: 1;
    }
    .image-reel .reel-image img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      display: block;
      border-radius: 12px;
    }

    /* ==========================================
       ENHANCED CSS - GRID LAYOUT FOR CLOTHING ITEMS
       ========================================== */
    
    /* Make image-info scrollable with padding */
    .image-info {
      height: 100%;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }

    /* AI Detection Loading Animation */
    .ai-analyzing {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f5f5f5;
      border-radius: 8px;
      margin: 20px 0;
    }

    .ai-analyzing .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #ddd;
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-analyzing span {
      font-size: 14px;
      color: #666;
    }

    /* Grid container for clothing items - FIXED 2 COLUMNS */
    .clothing-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 20px 0;
    }

    /* Clothing Item Cards */
    .clothing-item {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      height: fit-content;
    }

    .clothing-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .clothing-item h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .clothing-item p {
      margin: 6px 0;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }

    .clothing-item .brand {
      color: #000;
      font-weight: 500;
    }

    .clothing-item .price {
      color: #2a7f62;
      font-weight: 600;
      font-size: 16px;
      margin-top: 12px;
    }

    .image-info h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 16px 0;
      color: #222;
      position: sticky;
      top: 0;
      background: transparent;
      padding: 12px 0;
      z-index: 10;
    }

    .image-info h2:first-child {
      margin-top: 0;
      padding-top: 0;
    }

    /* Info section styling */
    .info-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>

<body>
  <div id="header-placeholder"></div>

  <div class="overlay"></div>

  <div class="explore-header">
    <div class="pages">
      <span class="page">For You</span>
      <span class="page">Friends</span>
      <span class="page">Brand of the Day</span>
      <span class="page">Following</span>
      <span class="page">Trending</span>
      <div class="underline"></div>
    </div>

    <div class="explore-searchbar">
      <img src="/assets/images/icons/search.png" class="explore-search-button">
      <input type="text" class="explore-searchbar-input" placeholder="search">
    </div>
  </div>

  <div class="filter-side-bar collapsed">
    <h2>Filters</h2>

    <h4>Gender</h4>
    <div class="choices">
      <div class="choice"><input type="checkbox"><p>Men</p></div>
      <div class="choice"><input type="checkbox"><p>Women</p></div>
    </div>

    <h4>Insert classifier here</h4>
    <div class="choices">
      <div class="choice"><input type="checkbox"><p>Outfits</p></div>
      <div class="choice"><input type="checkbox"><p>Clothing pieces</p></div>
    </div>

    <h4>Style</h4>
    <div class="choices">
      <div class="choice"><input type="checkbox"><p>Streetwear</p></div>
      <div class="choice"><input type="checkbox"><p>Date night</p></div>
      <div class="choice"><input type="checkbox"><p>Beach</p></div>
      <div class="choice"><input type="checkbox"><p>Stockholm</p></div>
      <div class="choice"><input type="checkbox"><p>Old money</p></div>
      <div class="choice"><input type="checkbox"><p>Gymwear</p></div>
    </div>

    <h4>Season</h4>
    <div class="choices">
      <div class="choice"><input type="checkbox"><p>Winter</p></div>
      <div class="choice"><input type="checkbox"><p>Spring</p></div>
      <div class="choice"><input type="checkbox"><p>Summer</p></div>
      <div class="choice"><input type="checkbox"><p>Fall</p></div>
    </div>
  </div>

  <button class="filter-toggle-btn" id="filterToggle">‚Üí</button>

  <div class="grid" id="gallery"></div>

  <div class="image-info-screen">
    <img class="back-button" src="/assets/images/icons/back.png">
    <div class="image-half">
      <img class="placeholder-img" src="/assets/images/icons/placeholder.jpg">
    </div>
    <div class="image-info" id="clothingDetails">
      <!-- AI-detected clothing details will be inserted here -->
    </div>
  </div>

  <div id="create-account-page-placeholder"></div>

  <!-- Your existing scripts -->
  <script type="module" src="/assets/js/pages/page-defaults.js"></script>
  <script type="module" src="/assets/js/components/load-images.js"></script>
  <script type="module" src="/assets/js/components/load-user.js"></script>
  <script src="/assets/js/pages/explore-page.js"></script>
  <script type="module" src="/assets/js/components/expand-images.js" defer></script>

  <!-- ‚úÖ Film Reel Style Image Viewer with AI Detection -->
  <script>
  // Filter toggle functionality
  const filterToggle = document.getElementById('filterToggle');
  const filterSidebar = document.querySelector('.filter-side-bar');

  filterToggle.addEventListener('click', () => {
    filterSidebar.classList.toggle('collapsed');
    // Change arrow direction
    filterToggle.textContent = filterSidebar.classList.contains('collapsed') ? '‚Üí' : '‚Üê';
  });

  document.addEventListener("DOMContentLoaded", () => {
    const gallery = document.querySelector("#gallery");
    const imageInfoScreen = document.querySelector(".image-info-screen");
    const imageHalf = imageInfoScreen.querySelector(".image-half");
    const placeholderImg = imageInfoScreen.querySelector(".placeholder-img");
    const backButton = imageInfoScreen.querySelector(".back-button");
    const overlay = document.querySelector(".overlay");
    const clothingDetails = document.getElementById("clothingDetails");

    let images = [];
    let currentIndex = -1;
    let isScrolling = false;
    let reel = null;

    // ========================================
    // AI CLOTHING DETECTION FUNCTION - UPDATED
    // ========================================
    async function detectClothing(imageUrl) {
      // Show loading state
      clothingDetails.innerHTML = `
        <div class="ai-analyzing">
          <div class="spinner"></div>
          <span>Analyzing clothing items...</span>
        </div>
      `;

      try {
        // Make sure URL is complete
        const fullImageUrl = imageUrl.startsWith('http') 
          ? imageUrl 
          : window.location.origin + imageUrl;

        console.log('üîç Sending image to AI:', fullImageUrl);

        // Call our backend API
        const response = await fetch('http://localhost:3000/api/detect-clothing', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ imageUrl: fullImageUrl })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        console.log('‚úÖ Received detection results:', data);
        
        if (data.success && data.items && data.items.length > 0) {
          displayClothingItems(data.items);
        } else {
          clothingDetails.innerHTML = `
            <h2>No Clothing Detected</h2>
            <p>No clothing items were identified in this image.</p>
          `;
        }
        
      } catch (error) {
        console.error('‚ùå Detection error:', error);
        clothingDetails.innerHTML = `
          <h2>Connection Error</h2>
          <p>Could not connect to the detection service.</p>
          <p style="color: #999; font-size: 12px;">Make sure the backend server is running on port 3000.</p>
          <p style="color: #999; font-size: 12px;">Error: ${error.message}</p>
        `;
      }
    }

    // Display detected clothing items in a grid layout
    function displayClothingItems(items) {
      let html = '<h2>Detected Clothing Items</h2>';
      
      if (items.length === 0) {
        html += '<p>No clothing items detected in this image.</p>';
      } else {
        html += '<div class="clothing-grid">';
        items.forEach((item, index) => {
          html += `
            <div class="clothing-item">
              <h3>${item.type}</h3>
              <p><strong>Item:</strong> ${item.name}</p>
              <p class="brand"><strong>Brand:</strong> ${item.brand}</p>
              <p><strong>Color:</strong> ${item.color}</p>
              <p><strong>Size:</strong> ${item.size}</p>
              <p class="price">${item.price}</p>
              ${item.confidence ? `<p style="font-size: 11px; color: #999;">Confidence: ${item.confidence}%</p>` : ''}
            </div>
          `;
        });
        html += '</div>';
      }

      html += `
        <div class="info-section">
          <h2>About This Detection</h2>
          <p>These items were detected using AI image recognition technology. Results may vary based on image quality.</p>
        </div>
      `;

      clothingDetails.innerHTML = html;
    }

    // Wait for dynamically loaded images
    const observer = new MutationObserver(() => {
      images = Array.from(gallery.querySelectorAll("img"));
      images.forEach((img, index) => {
        img.addEventListener("click", () => openImage(index));
      });
    });
    observer.observe(gallery, { childList: true, subtree: true });

    // Fallback if images already exist
    setTimeout(() => {
      images = Array.from(gallery.querySelectorAll("img"));
      images.forEach((img, index) => {
        img.addEventListener("click", () => openImage(index));
      });
    }, 1000);

    function createReel() {
      reel = document.createElement('div');
      reel.className = 'image-reel';
      
      // Create all image elements in the reel
      images.forEach((img, index) => {
        const reelImageContainer = document.createElement('div');
        reelImageContainer.className = 'reel-image';
        
        const reelImg = document.createElement('img');
        reelImg.src = img.src;
        
        reelImageContainer.appendChild(reelImg);
        reelImageContainer.style.top = `${index * 100}%`;
        reel.appendChild(reelImageContainer);
      });
      
      imageHalf.appendChild(reel);
      
      // Hide the original placeholder
      placeholderImg.style.opacity = '0';
      placeholderImg.style.pointerEvents = 'none';
    }

    function openImage(index) {
      if (!reel) {
        createReel();
      }
      
      currentIndex = index;
      
      // Position the reel to show the current image
      reel.style.transform = `translateY(-${currentIndex * 100}%)`;
      
      // Fade in current image, fade out others
      const reelImages = reel.querySelectorAll('.reel-image');
      reelImages.forEach((container, i) => {
        if (i === currentIndex) {
          container.classList.add('active');
        } else {
          container.classList.remove('active');
        }
      });
      
      // Run AI detection on the current image
      detectClothing(images[currentIndex].src);
      
      imageInfoScreen.classList.add("active");
      overlay.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function closeImage() {
      imageInfoScreen.classList.remove("active");
      overlay.classList.remove("active");
      document.body.style.overflow = "";
    }

    function showNextImage() {
      if (currentIndex < images.length - 1 && !isScrolling) {
        isScrolling = true;
        currentIndex++;
        
        const reelImages = reel.querySelectorAll('.reel-image');
        
        // Fade out current, fade in next
        reelImages[currentIndex - 1].classList.remove('active');
        reelImages[currentIndex].classList.add('active');
        
        // Scroll the reel
        reel.style.transform = `translateY(-${currentIndex * 100}%)`;
        
        // Run AI detection on new image
        detectClothing(images[currentIndex].src);
        
        setTimeout(() => {
          isScrolling = false;
        }, 200);
      }
    }

    function showPrevImage() {
      if (currentIndex > 0 && !isScrolling) {
        isScrolling = true;
        currentIndex--;
        
        const reelImages = reel.querySelectorAll('.reel-image');
        
        // Fade out current, fade in previous
        reelImages[currentIndex + 1].classList.remove('active');
        reelImages[currentIndex].classList.add('active');
        
        // Scroll the reel
        reel.style.transform = `translateY(-${currentIndex * 100}%)`;
        
        // Run AI detection on new image
        detectClothing(images[currentIndex].src);
        
        setTimeout(() => {
          isScrolling = false;
        }, 200);
      }
    }

    // Scroll wheel navigation
    imageInfoScreen.addEventListener("wheel", (e) => {
      if (!imageInfoScreen.classList.contains("active")) return;
      e.preventDefault();
      if (e.deltaY > 0) showNextImage();
      else if (e.deltaY < 0) showPrevImage();
    });

    // Arrow key navigation
    document.addEventListener("keydown", (e) => {
      if (!imageInfoScreen.classList.contains("active")) return;
      if (e.key === "ArrowRight" || e.key === "ArrowDown") showNextImage();
      else if (e.key === "ArrowLeft" || e.key === "ArrowUp") showPrevImage();
      else if (e.key === "Escape") closeImage();
    });

    // Close events
    backButton.addEventListener("click", closeImage);
    overlay.addEventListener("click", closeImage);
  });
  </script>
</body>
</html>